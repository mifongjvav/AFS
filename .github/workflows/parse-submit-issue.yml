name: Parse submit issue with status support

on:
  issues:
    types:
      - opened
      - edited
  issue_comment:
    types:
      - created

permissions:
  issues: write
  contents: read

jobs:
  handle-submit-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Handle submit issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const isIssueEvent = !!context.payload.issue && !context.payload.comment;
            const isCommentEvent = !!context.payload.comment;

            /* ===============================
               评论事件：@bot 且状态=制作中
            =============================== */
            if (isCommentEvent) {
              const issue = context.payload.issue;
              const comment = context.payload.comment;

              if ((issue.title || '').trim() !== '[提交请求]') return;
              if (!comment.body.includes('@github-actions')) return;

              const body = issue.body || '';
              const m =
                body.match(/状态（制作中\s*\|\s*待定）\s*[：:]\s*(.*)/) ||
                body.match(/状态\s*[：:]\s*(.*)/);

              const status = m && m[1] ? m[1].trim() : '待定';

              if (status === '制作中') {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `⚠️ @${owner} 当前提交状态为 **制作中**，请确认是否需要调整为 **待定**。`
                });
              }
              return;
            }

            /* ===============================
               Issue 事件：解析 + 校验 + JSON
            =============================== */
            const issue = context.payload.issue;
            const issueNumber = issue.number;

            if ((issue.title || '').trim() !== '[提交请求]') return;

            const body = issue.body || '';

            let block = body;
            const s = body.indexOf('[提交请求]');
            const e = body.indexOf('[END]');
            if (s !== -1 && e !== -1 && e > s) {
              block = body.slice(s + '[提交请求]'.length, e);
            }

            const kv = {};
            block
              .split(/\r?\n/)
              .map(l => l.trim())
              .filter(Boolean)
              .forEach(line => {
                let i = line.indexOf('：');
                if (i === -1) i = line.indexOf(':');
                if (i > -1) {
                  kv[line.slice(0, i).trim()] = line.slice(i + 1).trim();
                }
              });

            const pick = (...keys) => {
              for (const k of keys) {
                if (kv[k] !== undefined) return kv[k].trim();
              }
              return '';
            };

            const title = pick('标题');
            const desc = pick('简介', '描述');
            const link = pick('链接地址', '链接');
            const type = pick(
              '获取方式',
              '获取方式（jump | copy | download）'
            );

            const statusRaw = pick(
              '状态',
              '状态（制作中 | 待定）'
            );
            const status = statusRaw || '待定';

            const icon = pick('FontAwesome icon（留空为默认，格式为fas fa-图标名称）');
            const author = pick('作者', '原作者');
            const linkText = pick('获取按钮昵称', '获取按钮');
            const tags = pick(
              '标签（多个标签用英文逗号分隔）',
              '标签'
            );

            const errors = [];

            if (!title) errors.push('缺少必填字段：标题');
            if (!desc) errors.push('缺少必填字段：简介');
            if (!link) errors.push('缺少必填字段：链接地址');
            if (!type || !['jump','copy','download'].includes(type.toLowerCase())) {
              errors.push('获取方式必须是 jump / copy / download');
            }
            if (!['待定', '制作中'].includes(status)) {
              errors.push('状态只能是：待定 或 制作中');
            }

            const forbidden = ['invalid', '坟场', '过审', '上架', '用户喜爱'];

            if (errors.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: ['invalid']
              });

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: errors.map((e,i)=>`${i+1}. ${e}`).join('\n')
              });
              return;
            }

            const classes = [];

            if (tags) {
              tags
                .split(',')
                .map(t => t.trim())
                .filter(t => t && !forbidden.includes(t))
                .forEach(t => classes.push(t));
            }

            // 状态追加到 class 最后
            classes.push(status);

            const result = {
              title,
              icon: icon || 'fas fa-files',
              description: `<p>原作者：${author || ''}</p><p>${desc}</p>`,
              url: link,
              linkText: linkText || '',
              type: type.toLowerCase(),
              class: classes
            };

            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              labels: issue.labels.map(l=>l.name).filter(l=>!forbidden.includes(l))
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                `✅ 提交解析完成（状态：${status}）`,
                '```json',
                JSON.stringify(result, null, 2),
                '```'
              ].join('\n')
            });
