name: Parse submit issue with validation

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  parse-submit-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue, validate fields, reply JSON
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;
            const issueNumber = issue.number;

            // 仅处理 [提交请求]
            if ((issue.title || '').trim() !== '[提交请求]') return;

            const body = issue.body || '';

            // 提取内容块
            let block = body;
            const s = body.indexOf('[提交请求]');
            const e = body.indexOf('[END]');
            if (s !== -1 && e !== -1 && e > s) {
              block = body.slice(s + '[提交请求]'.length, e);
            }

            // 解析 键：值（支持中文 / 英文冒号）
            const kv = {};
            block.split(/\r?\n/)
              .map(l => l.trim())
              .filter(Boolean)
              .forEach(line => {
                let i = line.indexOf('：');
                if (i === -1) i = line.indexOf(':');
                if (i > -1) {
                  const k = line.slice(0, i).trim();
                  const v = line.slice(i + 1).trim();
                  kv[k] = v;
                }
              });

            // 同时支持 带括号 / 不带括号 键名
            const pick = (...keys) => {
              for (const k of keys) {
                if (kv[k] !== undefined) return kv[k].trim();
              }
              return '';
            };

            // 字段读取（兼容括号说明）
            const title = pick('标题');
            const desc = pick('简介', '描述', 'description');
            const link = pick('链接地址', '链接', 'link');
            const type = pick(
              '获取方式',
              '获取方式（jump | copy | download）',
              'type'
            );
            const icon = pick(
              'FontAwesome icon（留空为默认，格式为fas fa-图标名称）',
              'icon'
            );
            const author = pick('作者', '原作者', 'author');
            const linkText = pick('获取按钮昵称', '获取按钮', 'linkText');
            const tags = pick(
              '标签（多个标签用英文逗号分隔）',
              '标签',
              'class',
              'tags'
            );

            // ===== 严格校验 =====
            const errors = [];

            if (!title) errors.push('缺少必填字段：标题');
            if (!desc) errors.push('缺少必填字段：简介');
            if (!link) errors.push('缺少必填字段：链接地址');
            if (!type) {
              errors.push('缺少必填字段：获取方式');
            } else if (!['jump', 'copy', 'download'].includes(type.toLowerCase())) {
              errors.push(`获取方式必须是 jump / copy / download（当前：${type}）`);
            }

            // 校验失败 → invalid 标签 + 评论
            if (errors.length > 0) {
              const labels = issue.labels.map(l => l.name);
              if (!labels.includes('invalid')) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ['invalid']
                });
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: [
                  '❌ **提交内容校验失败**',
                  '',
                  ...errors.map((e,i)=>`${i+1}. ${e}`),
                  '',
                  '✅ **合法示例格式（支持括号说明）**：',
                  '```',
                  '[提交请求]',
                  '标题：示例标题',
                  '简介：这是一个示例简介（支持 Windows / Linux）',
                  '链接地址：https://example.com',
                  '获取方式（jump | copy | download）：download',
                  '获取按钮昵称：立即获取',
                  '标签（多个标签用英文逗号分隔）：工具,网络',
                  '[END]',
                  '```'
                ].join('\n')
              });
              return;
            }

            // ===== 校验通过 =====
            const forbidden = ['invalid', '坟场', '制作中', '待定', '过审', '上架', '用户喜爱'];
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              labels: issue.labels.map(l=>l.name).filter(l=>!forbidden.includes(l))
            });

            const classes = tags
              ? tags.split(',').map(t=>t.trim()).filter(Boolean)
              : [];

            const result = {
              title,
              icon: icon || 'fas fa-files',
              description: `<p>原作者：${author || ''}</p><p>${desc}</p>`,
              url: link,
              linkText: linkText || '',
              type: type.toLowerCase(),
              class: classes
            };

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                `✅ 提交校验通过，生成 JSON（@${owner}）：`,
                '```json',
                JSON.stringify(result, null, 2),
                '```'
              ].join('\n')
            });
