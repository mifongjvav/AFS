name: Parse submit issue with status support (robust parsing)

on:
  issues:
    types:
      - opened
      - edited
  issue_comment:
    types:
      - created

permissions:
  issues: write
  contents: read

jobs:
  handle-submit-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Handle submit issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const isIssueEvent = !!context.payload.issue && !context.payload.comment;
            const isCommentEvent = !!context.payload.comment;

            // helper: normalize a key name by removing parenthetical hints and trimming
            function normalizeKey(k) {
              if (!k) return '';
              // replace full-width （ ） and half-width ( )
              // remove any content inside parentheses, then trim
              return k.replace(/（.*?）/g, '')
                      .replace(/\(.*?\)/g, '')
                      .replace(/\u3000/g, ' ') // full-width space -> normal space
                      .trim();
            }

            // parse a body block into kv map with normalized keys
            function parseBlockToKV(block) {
              const kv = {};
              block.split(/\r?\n/)
                .map(l => l.trim())
                .filter(Boolean)
                .forEach(line => {
                  // find first colon (Chinese or English)
                  let i = line.indexOf('：');
                  if (i === -1) i = line.indexOf(':');
                  if (i > -1) {
                    const rawKey = line.slice(0, i).trim();
                    const rawVal = line.slice(i + 1).trim();
                    const key = normalizeKey(rawKey);
                    kv[key] = rawVal;
                  }
                });
              return kv;
            }

            // unified pick that looks up normalized keys and some variants
            function makePicker(kv) {
              return function pick(...keys) {
                for (const k of keys) {
                  const nk = normalizeKey(k);
                  if (kv[nk] !== undefined) return kv[nk].trim();
                }
                return '';
              };
            }

            /* =================================================
               评论事件：@bot 且 状态=制作中 → 提醒仓库所有者
            ================================================= */
            if (isCommentEvent) {
              const issue = context.payload.issue;
              const comment = context.payload.comment;

              if ((issue.title || '').trim() !== '[提交请求]') return;
              if (!comment.body.includes('@github-actions')) return;

              const body = issue.body || '';
              let block = body;
              const s = body.indexOf('[提交请求]');
              const e = body.indexOf('[END]');
              if (s !== -1 && e !== -1 && e > s) {
                block = body.slice(s + '[提交请求]'.length, e);
              }

              const kv = parseBlockToKV(block);
              const pick = makePicker(kv);
              const statusRaw = pick('状态', '状态（制作中 | 待定）');
              const status = statusRaw || '待定';

              if (status === '制作中') {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `⚠️ @${owner} 当前提交状态为 **制作中**，请确认是否需要调整为 **待定**。`
                });
              }
              return;
            }

            /* ===============================
               Issue 事件：解析 + 校验 + JSON
            =============================== */
            const issue = context.payload.issue;
            const issueNumber = issue.number;

            if ((issue.title || '').trim() !== '[提交请求]') return;

            const body = issue.body || '';

            let block = body;
            const s = body.indexOf('[提交请求]');
            const e = body.indexOf('[END]');
            if (s !== -1 && e !== -1 && e > s) {
              block = body.slice(s + '[提交请求]'.length, e);
            }

            const kv = parseBlockToKV(block);
            const pick = makePicker(kv);

            const title = pick('标题', 'title');
            const desc = pick('简介', '描述', 'description');
            const link = pick('链接地址', '链接', 'link');
            const type = pick('获取方式', '获取方式（jump | copy | download）', 'type');

            const statusRaw = pick('状态', '状态（制作中 | 待定）');
            const status = statusRaw || '待定';

            const icon = pick('FontAwesome icon（留空为默认，格式为fas fa-图标名称）', 'icon');
            const author = pick('作者', '原作者', 'author');
            const linkText = pick('获取按钮昵称', '获取按钮', 'linkText');
            const tags = pick('标签（多个标签用英文逗号分隔）', '标签', 'class', 'tags');

            const errors = [];

            if (!title) errors.push('缺少必填字段：标题');
            if (!desc) errors.push('缺少必填字段：简介');
            if (!link) errors.push('缺少必填字段：链接地址');
            if (!type || !['jump','copy','download'].includes(type.toLowerCase())) {
              errors.push('获取方式必须是 jump / copy / download');
            }
            if (!['待定', '制作中'].includes(status)) {
              errors.push('状态只能是：待定 或 制作中');
            }

            // 标签黑名单（包含 不允许在标签中出现的 状态值）
            const forbidden = [
              'invalid',
              '坟场',
              '过审',
              '上架',
              '用户喜爱',
              '制作中',
              '待定'
            ];

            if (errors.length > 0) {
              // add invalid label if not present
              const labelNames = issue.labels.map(l => l.name);
              if (!labelNames.includes('invalid')) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ['invalid']
                });
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: [
                  '❌ **提交内容校验失败**',
                  '',
                  ...errors.map((e,i)=>`${i+1}. ${e}`),
                  '',
                  '请修正后编辑 issue，系统会自动重新校验。',
                  '',
                  '参考格式（支持括号说明）：',
                  '```',
                  '[提交请求]',
                  '标题：示例标题',
                  '简介：示例简介（支持括号说明）',
                  '链接地址：https://example.com',
                  '获取方式（jump | copy | download）：download',
                  '状态（制作中 | 待定）：待定',
                  '获取按钮昵称：立即获取',
                  '标签（多个标签用英文逗号分隔）：工具,网络',
                  '[END]',
                  '```'
                ].join('\n')
              });
              return;
            }

            const classes = [];

            if (tags) {
              tags
                .split(',')
                .map(t => t.trim())
                .filter(t => t && !forbidden.includes(t))
                .forEach(t => classes.push(t));
            }

            // 最后追加状态（唯一来源）
            classes.push(status);

            const result = {
              title,
              icon: icon || 'fas fa-file',
              description: `<p>原作者：${author || ''}</p><p>${desc}</p>`,
              url: link,
              linkText: linkText || '',
              type: type.toLowerCase(),
              class: classes
            };

            // 清理 issue labels 中的黑名单项（包括制作中/待定）
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              labels: issue.labels
                .map(l => l.name)
                .filter(l => !forbidden.includes(l))
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                `✅ 提交解析完成（状态：${status}）`,
                '```json',
                JSON.stringify(result, null, 2),
                '```'
              ].join('\n')
            });
