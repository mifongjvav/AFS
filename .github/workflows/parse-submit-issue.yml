name: Parse submit issue with validation

on:
  issues:
    types:
      - opened
      - edited

permissions:
  issues: write
  contents: read

jobs:
  parse-submit-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue, validate fields, reply JSON
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;
            const issueNumber = issue.number;

            if ((issue.title || '').trim() !== '[提交请求]') {
              return;
            }

            const body = issue.body || '';

            let block = body;
            const start = body.indexOf('[提交请求]');
            const end = body.indexOf('[END]');
            if (start !== -1 && end !== -1 && end > start) {
              block = body.slice(start + '[提交请求]'.length, end);
            }

            const kv = {};
            block
              .split(/\r?\n/)
              .map(l => l.trim())
              .filter(Boolean)
              .forEach(line => {
                let idx = line.indexOf('：');
                if (idx === -1) idx = line.indexOf(':');
                if (idx > -1) {
                  const key = line.slice(0, idx).trim();
                  const val = line.slice(idx + 1).trim();
                  kv[key] = val;
                }
              });

            const pick = (...keys) => {
              for (const k of keys) {
                if (kv[k] !== undefined) {
                  return kv[k].trim();
                }
              }
              return '';
            };

            const title = pick('标题');
            const desc = pick('简介', '描述', 'description');
            const link = pick('链接地址', '链接', 'link');
            const type = pick(
              '获取方式',
              '获取方式（jump | copy | download）',
              'type'
            );
            const icon = pick(
              'FontAwesome icon（留空为默认，格式为fas fa-图标名称）',
              'icon'
            );
            const author = pick('作者', '原作者', 'author');
            const linkText = pick('获取按钮昵称', '获取按钮', 'linkText');
            const tags = pick(
              '标签（多个标签用英文逗号分隔）',
              '标签',
              'class',
              'tags'
            );

            const errors = [];

            if (!title) errors.push('缺少必填字段：标题');
            if (!desc) errors.push('缺少必填字段：简介');
            if (!link) errors.push('缺少必填字段：链接地址');
            if (!type) {
              errors.push('缺少必填字段：获取方式');
            } else if (!['jump', 'copy', 'download'].includes(type.toLowerCase())) {
              errors.push(`获取方式必须是 jump / copy / download（当前：${type}）`);
            }

            const forbidden = [
              'invalid',
              '坟场',
              '制作中',
              '待定',
              '过审',
              '上架',
              '用户喜爱'
            ];

            if (errors.length > 0) {
              const labelNames = issue.labels.map(l => l.name);
              if (!labelNames.includes('invalid')) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ['invalid']
                });
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: [
                  '❌ **提交内容校验失败**',
                  '',
                  ...errors.map((e, i) => `${i + 1}. ${e}`),
                  '',
                  '请修正后编辑 issue，系统会自动重新校验。',
                  '',
                  '```',
                  '[提交请求]',
                  '标题：示例标题',
                  '简介：示例简介（支持括号说明）',
                  '链接地址：https://example.com',
                  '获取方式（jump | copy | download）：download',
                  '获取按钮昵称：立即获取',
                  '标签（多个标签用英文逗号分隔）：工具,网络',
                  '[END]',
                  '```'
                ].join('\n')
              });
              return;
            }

            const cleanLabels = issue.labels
              .map(l => l.name)
              .filter(l => !forbidden.includes(l));

            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              labels: cleanLabels
            });

            const classes = tags
              ? tags
                  .split(',')
                  .map(t => t.trim())
                  .filter(t => t && !forbidden.includes(t))
              : [];

            const result = {
              title: title,
              icon: icon || 'fas fa-files',
              description: `<p>原作者：${author || ''}</p><p>${desc}</p>`,
              url: link,
              linkText: linkText || '',
              type: type.toLowerCase(),
              class: classes
            };

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                `✅ 提交校验通过，生成 JSON（@${owner}）：`,
                '```json',
                JSON.stringify(result, null, 2),
                '```'
              ].join('\n')
            });
