name: File upload issue to PR

on:
  issues:
    types:
      - opened
      - edited

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  handle-file-upload-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse uploaded files from issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            if (!issue) return;

            if ((issue.title || '').trim() !== '[文件上传请求]') {
              console.log('Not a file upload issue.');
              return;
            }

            const body = issue.body || '';
            const urls = new Set();

            // 1️⃣ Markdown links: (url)
            for (const m of body.matchAll(/\((https?:\/\/[^)\s]+)\)/g)) {
              urls.add(m[1]);
            }

            // 2️⃣ HTML src / href
            for (const m of body.matchAll(/(?:src|href)="(https?:\/\/[^"]+)"/g)) {
              urls.add(m[1]);
            }

            // 3️⃣ Bare URLs
            for (const m of body.matchAll(/https?:\/\/\S+/g)) {
              urls.add(m[0]);
            }

            // GitHub attachment whitelist
            const fileUrls = [...urls].filter(u =>
              u.includes('user-images.githubusercontent.com') ||
              u.includes('github.com/user-attachments/assets') ||
              u.includes('/files/')
            );

            if (fileUrls.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: [
                  '❌ **未检测到任何 GitHub 上传的附件**',
                  '',
                  '请直接拖拽或粘贴文件到 Issue 编辑框中。',
                  '支持的形式包括：',
                  '- Markdown 图片 / 文件',
                  '- HTML `<img src="...">`',
                  '- GitHub 新附件系统（user-attachments）'
                ].join('\n')
              });
              return;
            }

            const outputPath = path.join(process.cwd(), 'uploaded-files.txt');
            fs.writeFileSync(outputPath, fileUrls.join('\n') + '\n', 'utf8');

            console.log('Extracted files:', fileUrls);

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: add uploaded files list'
          title: '添加上传的文件列表'
          body: |
            本 PR 由 GitHub Action 自动生成。

            - 来源 Issue：#${{ github.event.issue.number }}
            - 内容：从 Issue 正文中提取的所有 GitHub 上传附件
            - 格式：根目录 `uploaded-files.txt`，每行一个文件 URL
          branch: file-upload/issue-${{ github.event.issue.number }}
          delete-branch: true
