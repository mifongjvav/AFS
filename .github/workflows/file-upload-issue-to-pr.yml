name: File upload issue -> comment with file links

on:
  issues:
    types:
      - opened
      - edited

permissions:
  issues: write
  contents: read

jobs:
  file-upload-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Parse uploads and comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            if (!issue) return;

            if ((issue.title || '').trim() !== '[文件上传请求]') {
              return;
            }

            const body = issue.body || '';
            const urls = new Set();

            // 1️⃣ Markdown links: (URL)
            for (const m of body.matchAll(/\((https?:\/\/[^)\s]+)\)/g)) {
              urls.add(m[1]);
            }

            // 2️⃣ HTML src / href
            for (const m of body.matchAll(/(?:src|href)=["'](https?:\/\/[^"']+)["']/g)) {
              urls.add(m[1]);
            }

            // 只允许 GitHub 上传附件
            const fileUrls = [...urls]
              .map(u => u.trim().replace(/[)"'>]+$/, '')) // 清理尾部脏字符
              .filter(u =>
                u.includes('user-images.githubusercontent.com') ||
                u.includes('github.com/user-attachments/assets') ||
                u.includes('/files/')
              );

            if (fileUrls.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '❌ 未检测到任何 GitHub 上传的附件，请直接拖拽或粘贴文件到 Issue 编辑器中。'
              });
              return;
            }

            function displayName(u) {
              try {
                const p = new URL(u).pathname.split('/').filter(Boolean);
                const last = p[p.length - 1];
                // 如果是 user-attachments 的 UUID，用通用名称
                if (/^[0-9a-f-]{36}$/i.test(last)) {
                  return 'GitHub 附件';
                }
                return decodeURIComponent(last);
              } catch {
                return 'GitHub 附件';
              }
            }

            const owner = context.repo.owner;
            const lines = fileUrls.map(u => `- [${displayName(u)}](${u})`);

            const comment = [
              `文件上传请求已收到 @${owner}，点击下载文件：`,
              '',
              ...lines,
              '',
              '（若文件无法下载，请确认 Issue 中的附件是通过 GitHub 编辑器上传的）'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: comment
            });
